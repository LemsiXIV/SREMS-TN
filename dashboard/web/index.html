<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>SREMS Local Dashboard</title>
  <style>
    body{font-family:sans-serif;margin:16px}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px}
    .card{border:1px solid #ddd;padding:12px;border-radius:8px}
    .bar{height:10px;background:#eee;border-radius:6px;overflow:hidden}
    .bar>div{height:100%;background:#06f;width:0%}
  </style>
</head>
<body>
  <h2>SREMS Local Dashboard</h2>
  <div class="grid">
    <div class="card"><b>Soiling</b><div class="bar"><div id="soilingBar"></div></div><div id="soilingText">-</div></div>
    <div class="card"><b>Health</b><div class="bar"><div id="healthBar"></div></div><div id="healthText">-</div></div>
    <div class="card"><b>Battery</b><div id="battText">-</div></div>
    <div class="card"><b>Pump</b><div id="pumpText">-</div></div>
    <div class="card"><b>Cleaning due</b><div id="cleanText">-</div></div>
    <div class="card"><b>Energy loss est.</b><div id="lossText">-</div></div>
  </div>
  <canvas id="p" width="360" height="120" style="margin-top:16px;"></canvas>
  <script>
    async function load(){ const r = await fetch('/api/data'); const j = await r.json(); const d=j.data;
      if(!d.length) return;
      const last=d[d.length-1];
      const sPct=(last.soiling*100)||0, hPct=(last.health*100)||0;
      document.getElementById('soilingBar').style.width=sPct.toFixed(0)+'%';
      document.getElementById('healthBar').style.width=hPct.toFixed(0)+'%';
      document.getElementById('soilingText').textContent=sPct.toFixed(1)+'%';
      document.getElementById('healthText').textContent=hPct.toFixed(0)+'%';
      document.getElementById('battText').textContent=(last.batt_mv/1000).toFixed(2)+' V';
      const pumpOn = last.pump_ma > 200;
      document.getElementById('pumpText').textContent = pumpOn ? 'ON' : 'OFF';
      document.getElementById('cleanText').textContent =
        (last.pred_days>=0 ? (last.pred_days.toFixed(1)+' days') : 'n/a');
      const lossPct = (last.soiling*100)||0;
      document.getElementById('lossText').textContent = lossPct.toFixed(1)+'%';
      const ctx=document.getElementById('p').getContext('2d');
      const ys=d.map(x=>x.p_act_w); const max=Math.max(...ys,1), min=0;
      ctx.clearRect(0,0,360,120); ctx.beginPath(); ctx.strokeStyle='#06f';
      ys.forEach((y,i)=>{ const xp=i*(360/Math.max(1,ys.length-1)); const yp=110-((y-min)/(max-min))*100; if(i==0) ctx.moveTo(xp,yp); else ctx.lineTo(xp,yp);}); ctx.stroke();
    }
    setInterval(load, 3000); load();
  </script>
</body>
</html>
